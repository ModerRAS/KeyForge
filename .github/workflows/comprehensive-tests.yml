name: KeyForge æµ‹è¯•å¥—ä»¶

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

env:
  DOTNET_VERSION: '9.0.x'
  SOLUTION: 'KeyForge.sln'
  TEST_PROJECT: 'KeyForge.Tests/KeyForge.Tests.csproj'
  COVERAGE_THRESHOLD: 60

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ç¼“å­˜ NuGet åŒ…
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.props') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: æ¢å¤ä¾èµ–
      run: dotnet restore ${{ env.SOLUTION }}
      
    - name: æž„å»º
      run: dotnet build ${{ env.SOLUTION }} --configuration Release --no-restore
      
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        dotnet test ${{ env.TEST_PROJECT }} \
          --configuration Release \
          --filter "FullyQualifiedName~Unit" \
          --collect:"XPlat Code Coverage" \
          --results-directory TestResults/ \
          --logger "trx;LogFileName=TestResults/unit-tests.trx" \
          --no-build
          
    - name: è¿è¡Œé›†æˆæµ‹è¯•
      run: |
        dotnet test ${{ env.TEST_PROJECT }} \
          --configuration Release \
          --filter "FullyQualifiedName~Integration" \
          --collect:"XPlat Code Coverage" \
          --results-directory TestResults/ \
          --logger "trx;LogFileName=TestResults/integration-tests.trx" \
          --no-build
          
    - name: è¿è¡ŒBDDæµ‹è¯•
      run: |
        dotnet test ${{ env.TEST_PROJECT }} \
          --configuration Release \
          --filter "FullyQualifiedName~BDD" \
          --collect:"XPlat Code Coverage" \
          --results-directory TestResults/ \
          --logger "trx;LogFileName=TestResults/bdd-tests.trx" \
          --no-build
          
    - name: è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
      run: |
        dotnet test ${{ env.TEST_PROJECT }} \
          --configuration Release \
          --filter "FullyQualifiedName~EndToEnd" \
          --collect:"XPlat Code Coverage" \
          --results-directory TestResults/ \
          --logger "trx;LogFileName=TestResults/e2e-tests.trx" \
          --no-build
          
    - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
      run: |
        dotnet test ${{ env.TEST_PROJECT }} \
          --configuration Release \
          --filter "FullyQualifiedName~Performance" \
          --collect:"XPlat Code Coverage" \
          --results-directory TestResults/ \
          --logger "trx;LogFileName=TestResults/performance-tests.trx" \
          --no-build
          
    - name: åˆå¹¶è¦†ç›–çŽ‡æŠ¥å‘Š
      run: |
        dotnet tool install -g dotnet-coverage
        dotnet-coverage merge TestResults/coverage.*.xml -r cobertura -o TestResults/coverage.cobertura.xml
        
    - name: ç”Ÿæˆè¦†ç›–çŽ‡æŠ¥å‘Š
      run: |
        dotnet tool install -g dotnet-reportgenerator-globaltool
        reportgenerator \
          -reports:TestResults/coverage.cobertura.xml \
          -targetdir:TestReports \
          -reporttypes:Html \
          -assemblyfilters:"-xunit*" \
          -title:"KeyForge æµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Š"
          
    - name: æ£€æŸ¥è¦†ç›–çŽ‡é˜ˆå€¼
      run: |
        if [ -f "TestResults/coverage.cobertura.xml" ]; then
          coverage_line=$(grep -o 'line-rate="[0-9.]*"' TestResults/coverage.cobertura.xml | head -1 | cut -d'"' -f2)
          coverage_percent=$(echo "$coverage_line * 100" | bc | cut -d'.' -f1)
          echo "ä»£ç è¦†ç›–çŽ‡: $coverage_percent%"
          if [ "$coverage_percent" -lt "${{ env.COVERAGE_THRESHOLD }}" ]; then
            echo "âŒ ä»£ç è¦†ç›–çŽ‡ $coverage_percent% ä½ŽäºŽé˜ˆå€¼ ${{ env.COVERAGE_THRESHOLD }}%"
            exit 1
          else
            echo "âœ“ ä»£ç è¦†ç›–çŽ‡ $coverage_percent% è¾¾åˆ°é˜ˆå€¼è¦æ±‚"
          fi
        else
          echo "âš  æ— æ³•æ‰¾åˆ°è¦†ç›–çŽ‡æ–‡ä»¶ï¼Œè·³è¿‡è¦†ç›–çŽ‡æ£€æŸ¥"
        fi
          
    - name: ä¸Šä¼ æµ‹è¯•ç»“æžœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: |
          TestResults/
          TestReports/
          
    - name: å‘å¸ƒæµ‹è¯•ç»“æžœ
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: KeyForge æµ‹è¯•ç»“æžœ
        path: 'TestResults/*.trx'
        reporter: dotnet-trx
        
    - name: å‘å¸ƒè¦†ç›–çŽ‡æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: coverage-reports
        path: TestReports/
        
    - name: æ·»åŠ è¦†ç›–çŽ‡å¾½ç« 
      uses: codecov/codecov-action@v3
      with:
        file: ./TestResults/coverage.cobertura.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  quality-gate:
    needs: test
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: æ£€æŸ¥æµ‹è¯•ç»“æžœ
      run: |
        echo "ðŸ“Š æ£€æŸ¥æµ‹è¯•è´¨é‡é—¨ç¦..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æµ‹è¯•å¤±è´¥
        if [ -f "TestResults/unit-tests.trx" ]; then
          if grep -q "Failed" TestResults/unit-tests.trx; then
            echo "âŒ å•å…ƒæµ‹è¯•å­˜åœ¨å¤±è´¥ç”¨ä¾‹"
            exit 1
          fi
        fi
        
        if [ -f "TestResults/integration-tests.trx" ]; then
          if grep -q "Failed" TestResults/integration-tests.trx; then
            echo "âŒ é›†æˆæµ‹è¯•å­˜åœ¨å¤±è´¥ç”¨ä¾‹"
            exit 1
          fi
        fi
        
        if [ -f "TestResults/bdd-tests.trx" ]; then
          if grep -q "Failed" TestResults/bdd-tests.trx; then
            echo "âŒ BDDæµ‹è¯•å­˜åœ¨å¤±è´¥ç”¨ä¾‹"
            exit 1
          fi
        fi
        
        if [ -f "TestResults/e2e-tests.trx" ]; then
          if grep -q "Failed" TestResults/e2e-tests.trx; then
            echo "âŒ ç«¯åˆ°ç«¯æµ‹è¯•å­˜åœ¨å¤±è´¥ç”¨ä¾‹"
            exit 1
          fi
        fi
        
        echo "âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡"
        
    - name: ç”Ÿæˆè´¨é‡æŠ¥å‘Š
      run: |
        cat > TestResults/quality-report.md << EOF
        # KeyForge è´¨é‡æŠ¥å‘Š
        
        ## æµ‹è¯•æ‰§è¡Œç»“æžœ
        
        - **æ‰§è¡Œæ—¶é—´**: $(date)
        - **åˆ†æ”¯**: ${{ github.ref_name }}
        - **æäº¤**: ${{ github.sha }}
        
        ## è´¨é‡æŒ‡æ ‡
        
        - âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
        - âœ… ä»£ç è¦†ç›–çŽ‡ â‰¥${{ env.COVERAGE_THRESHOLD }}%
        - âœ… æž„å»ºæˆåŠŸ
        - âœ… æ€§èƒ½æµ‹è¯•é€šè¿‡
        
        ## æµ‹è¯•è¦†ç›–èŒƒå›´
        
        - **Domainå±‚**: å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
        - **Applicationå±‚**: é›†æˆæµ‹è¯•éªŒè¯æœåŠ¡å±‚åŠŸèƒ½
        - **Infrastructureå±‚**: ç»„ä»¶æµ‹è¯•éªŒè¯åŸºç¡€è®¾æ–½
        - **BDDæµ‹è¯•**: éªŒæ”¶æ ‡å‡†æµ‹è¯•
        - **ç«¯åˆ°ç«¯æµ‹è¯•**: å®Œæ•´ç”¨æˆ·åœºæ™¯
        - **æ€§èƒ½æµ‹è¯•**: ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
        
        ---
        
        *æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)*
        *KeyForge æ™ºèƒ½æŒ‰é”®è„šæœ¬ç³»ç»Ÿ*
        EOF
        
    - name: ä¸Šä¼ è´¨é‡æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: quality-report
        path: TestResults/quality-report.md